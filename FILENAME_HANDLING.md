# 📝 Video Hunter 文件名处理改进

## 🎯 问题描述

用户在使用UI界面输入自定义文件名时，下载的视频格式不可打开，主要原因是：

1. **扩展名问题**：用户输入的文件名可能没有包含正确的扩展名
2. **特殊字符问题**：文件名包含不安全的字符导致文件系统错误
3. **yt-dlp模板问题**：需要正确的输出模板格式

## ✅ 解决方案

### 1. 后端文件名处理 (`internal/downloader/ytdlp_downloader.go`)

#### 新增函数：
- `processOutputFilename()` - 处理输出文件名
- `sanitizeFilename()` - 清理文件名中的不安全字符

#### 处理逻辑：
```go
// 处理用户输入的文件名
if outputFile == "" {
    // 使用默认模板
    outputFile = "%(title)s.%(ext)s"
} else {
    // 处理用户输入的文件名
    outputFile = y.processOutputFilename(outputFile)
}
```

#### 文件名处理规则：
1. **无扩展名**：自动添加 `.%(ext)s`
   - 输入：`我的视频` → 输出：`我的视频.%(ext)s`
2. **有扩展名**：替换为 yt-dlp 模板
   - 输入：`我的视频.mp4` → 输出：`我的视频.%(ext)s`
3. **特殊字符**：自动清理
   - 输入：`我的视频/测试:文件*名?.txt` → 输出：`我的视频_测试_文件_名_.%(ext)s`

### 2. 前端文件名处理 (`web/static/js/app.js`)

#### 新增函数：
- `sanitizeFilename()` - 前端文件名清理

#### 处理逻辑：
```javascript
// 处理文件名
if (output) {
    // 移除不安全的字符
    output = this.sanitizeFilename(output);
    
    // 如果用户输入了扩展名，提示用户
    if (output.includes('.')) {
        const extension = output.split('.').pop().toLowerCase();
        if (!['%(ext)s', 'mp4', 'webm', 'mkv', 'avi', 'mov', 'flv'].includes(extension)) {
            this.showNotification('文件名已自动处理，系统会自动添加正确的扩展名', 'info');
        }
    }
}
```

### 3. UI界面改进 (`web/templates/index.html`)

#### 更新内容：
- 更清晰的标签：`文件名 (可选)`
- 更好的占位符：`例如: 我的视频 (无需输入扩展名，系统会自动添加)`
- 添加说明文字：`留空使用视频原标题，系统会自动处理扩展名`

## 🧪 测试验证

### 测试脚本：`test_filename.sh`

测试了以下场景：
1. ✅ **无扩展名文件名**：`我的测试视频` → `我的测试视频.%(ext)s`
2. ✅ **带扩展名文件名**：`我的测试视频.mp4` → `我的测试视频.%(ext)s`
3. ✅ **特殊字符文件名**：`我的测试视频/测试:文件*名?.txt` → `我的测试视频_测试_文件_名_.%(ext)s`
4. ✅ **空文件名**：`""` → `%(title)s.%(ext)s`

### 实际文件验证：
```bash
ls -la downloads/
# 输出：
# -rw-r--r--  1 qx  staff  11750943  6  5 07:28 我的测试视频_测试_文件_名_.mp4
# -rw-r--r--  1 qx  staff  11750943  6  5 07:28 我的测试视频.mp4
```

## 🔧 技术细节

### 不安全字符列表：
```go
unsafeChars := []string{"/", "\\", ":", "*", "?", "\"", "<", ">", "|"}
```

### yt-dlp 输出模板：
- `%(title)s` - 视频标题
- `%(ext)s` - 文件扩展名
- `%(id)s` - 视频ID
- `%(uploader)s` - 上传者

### 支持的视频格式：
- `mp4`, `webm`, `mkv`, `avi`, `mov`, `flv`

## 🎉 改进效果

### 用户体验提升：
- ✅ **无需手动输入扩展名**：系统自动处理
- ✅ **智能文件名清理**：自动移除不安全字符
- ✅ **清晰的操作提示**：界面提供明确的使用说明
- ✅ **错误预防**：前端和后端双重验证

### 技术改进：
- ✅ **向后兼容**：不影响现有功能
- ✅ **安全性提升**：防止文件系统错误
- ✅ **可维护性**：代码结构清晰，易于扩展

## 📋 使用指南

### 推荐的文件名输入方式：
1. **简单名称**：`我的视频` (推荐)
2. **描述性名称**：`Rick Astley 经典歌曲`
3. **带分类的名称**：`音乐视频_经典老歌`

### 避免的输入方式：
1. ❌ **包含扩展名**：`我的视频.mp4` (系统会自动处理)
2. ❌ **特殊字符**：`我的视频/测试:文件*名?.txt`
3. ❌ **过长名称**：超过255字符的文件名

## 🚀 未来改进

1. **智能文件名生成**：基于视频标题自动生成合适的文件名
2. **文件名模板**：支持用户自定义文件名模板
3. **批量重命名**：支持下载完成后批量重命名文件
4. **文件格式检测**：自动检测并显示支持的文件格式

---

**享受更好的文件名处理体验！** 🎬✨ 